# progress.md

## 現状動作していること

- `tools`ディレクトリ以下のモジュールを分割・整理
  - `process_alignment.py` から MFA 実行関連の関数を `mfa_runner.py` に移動
  - `process_alignment.py` から TextGrid パース・lab ファイル出力関連の関数を `textgrid_parser.py` に移動
  - `match_phonemes.py` から音素マッチングロジックを `phoneme_matcher.py` に移動
  - `match_phonemes.py` から `symbol_mapping.json` 読み込みロジックを `symbol_loader.py` に移動
  - `extract_feature.py` からユーティリティ関数 `add_silence_phonemes` を `feature_extractor_utils.py` に移動
  - 各メイン処理ファイル (`process_alignment.py`, `match_phonemes.py`, `extract_feature.py`) の import 文を修正
- match_phonemes.py のバグを修正
  - 無効な音素ペア（マッピングが存在しないペア）があった場合に確実にエラーを発生させるように修正
  - アライメントの最終スコア（`final_score`）を評価し、0 以下の場合は ValueError を発生
  - アライメント検証ロジックを `verify_complete_alignment` 関数として切り出し、コード品質を向上
  - 両方の音素列のすべての音素が確実にアライメントに含まれているかを検証するロジックを追加
  - 不完全なアライメントを早期に検出し、わかりやすいエラーメッセージで知らせる機能を実装
  - `match_phonemes` 関数内でアライメント検証を行うよう変更し、責任範囲を明確化
  - `test_match_phonemes_invalid_mapping`テストが正常に通るようになり、システムの堅牢性が向上
- GitHub Actions のワークフローファイル（.github/workflows/test.yml）を作成
  - すべてのブランチを対象に、push するたびにテストを実行するよう設定
  - リント・フォーマットのチェックを実行
  - VOICEVOX_engine のワークフローを参考に命名規則を統一
- Linux 環境でのテスト実行に対応するため、テストコードを修正
  - tools/test_festival.py のシラブルインデックスを修正
  - tools/test_phonemizer.py の音素表現を修正（`'aɪ'`を`'ᵻ'`に変更）
  - tools/test_syllable.py の音素表現とシラブルインデックスを修正
  - tools/**snapshots**/test_extract_feature/test_extract_aligned_feature_with_real_data.json のスナップショットを更新
- tools/process_alignment.py, tools/extract_feature.py に対する syrupy スナップショットテストを追加
  - tools/data/_.txt, _.wav を使った統合的な出力検証
  - syrupy を dev 依存として導入
  - tools/conftest.py で JSON スナップショット用 fixture を定義
  - tools/test_process_alignment.py で alignment 関数のスナップショットテストを実装
  - tools/test_extract_feature.py で extract_aligned_feature 関数の JSON スナップショットテストを実装
  - 初回は `uv run pytest tools/test_process_alignment.py tools/test_extract_feature.py --snapshot-update` でスナップショット生成
  - 以降は通常の pytest コマンドでスナップショット差分を検知可能
- tools/extract_feature.py を実装
  - テキストと wav ファイルから音素・シラブル・ストレス・アライメント情報を結合
  - AlignedPhonemeInfo モデルで型安全な情報管理
  - add_silence_phonemes 関数で先頭・末尾に必ず無音要素を追加
  - 音素不一致時は例外的に警告扱い（extract_feature.py のみ特例）
  - lab_entries の start/end アライメント情報と統合
  - process_syllable.py/process_alignment.py 関数を再利用し効率的に実装
- festival と phonemizer の音素列を適切にアライメントするモジュール（tools/match_phonemes.py）を実装
  - 動的計画法を使用して最適なアライメントを計算
  - 1:1、1:多、多:1 の音素マッピングに対応
  - symbol_mapping.json の情報を活用
  - 不整合があった場合は例外を発生させる
- symbol_mapping.json の大規模拡充・ソート
  - festival 要素数 1/2/記号ごとにブロック分割しアルファベット順に整理
  - 多数の音素マッピングを追加（例: y-ɪ, n-ŋ, ao-oːɹ, ax-ɛ など）
  - `z` と `z` のマッピングを追加
  - `ih` と `aɪ` のマッピングを追加
  - `ih` と `ᵻ` のマッピングを追加
  - カンマ（`,`）、感嘆符（`!`）、ピリオド（`.`）、疑問符（`?`）のマッピングを追加
- process_syllable.py（旧 extract_feature.py）の改善
  - ストレス情報は同一シラブル内で同じ値となる仕様を明文化・実装・テスト・ドキュメントで統一
  - ストレス検証ロジックを「全て 0 か、連続する 1 もしくは 2 が 1 度のみ現れてそれ以外が 0 か」を許容する仕様に修正
  - 警告からエラーへの変更（不整合があった場合は例外を発生させる）
  - 音素列のアライメントに基づいて情報を統合するロジックの改善
  - ファイル命名規則の統一
    - tools/extract_feature.py を tools/process_syllable.py にリネーム
    - tools/test_extract_feature.py を tools/test_process_syllable.py にリネーム
    - 他の process\_\*系ファイルと命名規則を統一
- コーディング規約・スタイルの徹底
  - 不要なコメントの削除
  - docstring の簡素化（Args/Returns セクションの削除）
  - 使われていない関数の削除（validate_alignment）
  - 例外処理の統一
  - 単一責任の原則を適用した関数分割
- テストの期待値を実際の出力に合わせて修正
  - phonemizer 出力の音素変更（「ᵻ」→「aɪ」）に対応
  - festival 出力のストレス値変更に対応
  - シラブルインデックスの変更に対応
  - 外部ライブラリのバージョンアップや内部アルゴリズム変更に対応
- tools/process_alignment.py を大幅に改良
  - TextGrid 形式から lab 形式（開始秒・終了秒・音素記号のスペース区切り）に出力形式を変更
  - TextGrid は一時ディレクトリに出力し、lab 形式に変換して最終出力
  - lab 形式の各行情報を pydantic.BaseModel（LabEntry）で管理
  - 関数順序を process_phonemizer.py や process_festival.py と完全に統一（main→parse_args→ ロジック本体 → サブロジック → 出力関数）
  - glob パターンによるファイル指定に対応（`--text_glob`、`--wav_glob`）
  - glob パターンを展開する処理を`expand_glob_pattern`関数として切り出し
  - 出力先ディレクトリを必須パラメータに変更（`--output_dir`に`required=True`を追加）
  - 一時ディレクトリを`tempfile.TemporaryDirectory`で自動削除するように変更
  - ログ出力を他の process\_\*.py ファイルと細部まで統一（詳細なデバッグログ、エラーロギング、コマンド実行ログなど）
  - テキストファイルと音声ファイルの数が一致しない場合のエラーハンドリングを追加
  - MFA の align コマンドに`--clean`と`--overwrite`オプション追加
  - prepare_corpus_dir 関数で既存のディレクトリを削除してから新規作成するように修正
  - run_mfa_align 関数で出力ディレクトリが存在する場合は事前に削除するように修正
  - TextGrid ファイルの空のテキスト区間（ポーズ）を"(.)"として出力するように修正
- tools/process_festival.py, tools/process_phonemizer.py, tools/process_syllable.py（旧 tools/extract_feature.py）で英語テキストの音素・シラブル・ストレス強弱等を抽出し、pydantic 型・logger・CLI/ロジック分離・pytest テスト・コーディング規約統一を徹底
- tools/process*mfa.py を新規実装し、他の tools/process*\*.py と完全に同じ設計・書式・例外伝播に統一
- validate_mfa_command で conda コマンド・mfa 環境・mfa コマンドの存在を事前検証し、エラー時は docs/mfa.md 参照を案内
- argparse の nargs, help, description, print_help, sys.exit 等の細部まで統一
- ドキュメント（docs/mfa.md）は最小限のインストール・動作確認のみ記載
- KPT で「徹底比較・一括設計・能動的な統一」の重要性を明文化
- 既存 tools/process\_\*.py との一行単位の徹底比較・統一を実践
- tools/process_festival.py で英語テキストから音素・シラブル・ストレス情報を Festival 経由で抽出し、word_index, phoneme_index, syllable_index を全体通し番号で付与し、pydantic 型・json 出力・logger/verbose 分離・pytest テストまで徹底
- tools/process_phonemizer.py で英語テキストから音素・ストレス強弱情報を phonemizer+espeak 経由で抽出し、word_index, phoneme_index を全体通し番号で付与し、pydantic 型・logger・CLI/ロジック分離・pytest テストまで徹底
- tools/process_syllable.py（旧 tools/extract_feature.py）で festival/phonemizer 両方の出力を統合し、音素・シラブル・単語・ストレス強弱・各種インデックスを一括で返す関数を実装
- tools/test_process_syllable.py（旧 tools/test_extract_feature.py）で pytest.mark.parametrize による厳密なテストを追加し、期待値を実装出力に完全同期
- dict.json（festival/phonemizer 音素対応辞書）の運用ルールを厳格化し、未登録音素ペアの推定・難単語（20 語以上）を解析・追加
- OS 自動判別（macOS: ./festival/bin/festival, Linux: festival）でクロスプラットフォーム対応
- festival/phonemizer の Ubuntu/macOS セットアップ手順を docs/ に反映
- .gitignore に Python 公式テンプレートを反映
- 多様なテストケースで安定動作を確認
- pytest.mark.parametrize で全テストを厳密にパターン化し、全プロパティの期待値を assert
- テスト期待値は実装出力に完全同期
- pytest による自動テストが全ての test\_\*.py で常時検証可能
- README.md に主要ツールの使い方・依存ライブラリの紹介・テスト方法を明記
- ロギング設定の統一
  - `utility/logger_utility.py`の`logging_setting`関数を変更し、引数を`verbose`フラグのみに統一。ログレベルは`verbose`フラグに基づいて決定し、出力先は常に`sys.stderr`に固定。
  - 各`process_*.py`および`extract_feature.py`スクリプトの`main`関数および主要ロジック関数で`logging_setting`の呼び出し方を変更し、`verbose`フラグを直接渡すように修正。
  - `tools/conftest.py`に`pytest_configure`フックを追加し、pytest の verbosity（`-v`オプションの有無）に応じてログレベルを設定するように変更。
- `tools/extract_feature.py`と`tools/process_alignment.py`のコマンドライン引数に`--output_textgrid_dir`を追加し、TextGrid ファイルの出力先を任意で指定できるように変更。
- `tools`ディレクトリ以下の CLI ツール（`extract_feature.py`, `process_alignment.py`, `process_festival.py`, `process_phonemizer.py`, `process_syllable.py`）に`typer`を導入し、`argparse`を置き換え。
- 上記 CLI ツールのうち、`process_festival.py`, `process_phonemizer.py`, `process_syllable.py` の `text` 引数を `typer.Argument` に修正し、Usage 通りの動作を保証。`process_alignment.py`, `extract_feature.py` は `typer.Option` のまま変更なし。

## 残タスク

- 音素マッピングの整備と拡充・ソート
  - 不足している音素マッピングの網羅的な追加・アルファベット順ソート・記号/複数音素/単音素ブロック分割
  - 複雑な単語や句のマッピング検証
- アライメントロジックのさらなる堅牢化
  - エッジケースのテスト強化
  - エラーメッセージの改善
- CI の安定化と拡張
  - テストカバレッジの追加
  - コードフォーマットチェックの追加
  - 型チェックの追加
- Linux と macOS の環境差異を吸収するテスト設計の改善
  - テストコードの修正を完了させる
  - スナップショットテストの更新を完了させる
- シラブル・音素・ストレス・単語情報を 1 コマンドで抽出する CLI/API の実装
- ファイル出力機能や記号フィルタ機能など process_syllable.py（旧 extract_feature.py）の拡張
- phonemizer の高度な利用例やバックエンド切替の検証
- CI/CD 強化や他言語対応の検討

## 現在のステータス

- `tools`ディレクトリ以下のモジュール構成を改善し、各ファイルの行数を削減、責務を明確化
- GitHub Actions による CI 環境を構築
  - push するたびにテストを実行
  - リント・フォーマットのチェックを実行
- match_phonemes.py のアライメント検証機能を強化
  - `verify_complete_alignment` 関数の追加による検証ロジックの明確化
  - 不完全なアライメントを確実に検出し、適切なエラーメッセージを提供
  - 単一責任の原則に基づく関数の整理により、コードの可読性と保守性が向上
- Linux 環境でのテスト実行に対応するためのコード修正を進行中
- festival/phonemizer/mfa の個別出力・統合出力ともに型安全・json 出力・コーディング規約・例外処理・フォーマット・logger/verbose 分離・pytest テスト・README/ドキュメント整備まで安定動作
- validate_mfa_command で MFA 環境の事前検証・明確なエラー案内が可能
- word_index, phoneme_index, syllable_index を含む全プロパティが厳密にテスト・CI で検証されている
- festival/phonemizer ともに Ubuntu/macOS で公式パッケージ・PyPI で安定運用可能
- 記号や空白の扱いも明確化されている
- 辞書運用・難単語解析・未登録音素ペアの追加運用により網羅性・拡張性が向上
- process_alignment.py が複数ファイル対応・一時ディレクトリ自動削除・出力先必須化・詳細ログ出力により使いやすさと安定性が向上
- 共通処理を関数として切り出し、コードの再利用性と可読性を向上（例：`expand_glob_pattern`関数、`verify_complete_alignment`関数）
- ロギング設定が統一され、pytest の verbosity と連動するようになった。
- TextGrid ファイルの出力先を任意で指定できるようになった。

## 既知の課題

- festival: シラブル取得可・ストレス強弱不可
- phonemizer: ストレス強弱取得可・シラブル不可
- Festival の No default voice found ワーニングは依然出力される（機能自体には影響なし）
- 記号や空白を用途に応じてフィルタする必要がある
- MFA のデフォルト動作（`--clean`と`--overwrite`が False）により、明示的にオプション指定しないと以前の実行結果が残る可能性がある
- 外部ライブラリ（phonemizer/festival）のバージョンアップや内部アルゴリズム変更により出力が変わる可能性がある
- Linux 環境と macOS 環境で音素表現やシラブルインデックスなどの出力に差異がある
- 特定の複雑な単語では音素アライメントが不完全になる可能性があり、symbol_mapping.json の継続的な拡充が必要

## 意思決定の経緯・履歴

- `tools`ディレクトリのモジュール分割を実施し、コードの可読性とメンテナンス性を向上させる方針を採用
- GitHub Actions を導入し、CI を構築する方針を採用
  - すべてのブランチを対象に、push するたびにテストを実行
  - VOICEVOX_engine のワークフローを参考に命名規則を統一
- Linux 環境と macOS 環境の差異を吸収するテスト設計を採用
  - テストコードを環境に合わせて修正
  - スナップショットテストを更新
- テスト期待値は実際の出力に合わせて更新し、CI/テストの安定性を確保する方針を採用
- 外部ライブラリの出力変更に柔軟に対応するテスト設計を重視
- print や json.dumps による見やすいデバッグ出力を重視
- logger/verbose/出力分離・pytest による自動テスト・README への手順明記
- コードフォーマット・型厳密化・例外処理（raise ... from e）を徹底
- pydantic 導入により PhonemeInfo 型で全出力を厳密に管理
- OS 差異を吸収する実装・ドキュメント・.gitignore・テストの整備を重視
- festival/phonemizer/mfa の出力統合・型設計・テスト設計を最優先
- KPT で「徹底比較・一括設計・能動的な統一」の重要性を明文化
- 外部ツール（MFA）のデフォルト動作を理解し、必要なオプションを明示的に指定することの重要性を確認
- 詳細なログ出力による処理フローの可視化を全ファイルで統一し、デバッグ・問題解決を容易に
- 一時ファイル・ディレクトリの自動削除によるクリーンな実行環境の維持を徹底
- 共通処理は関数として切り出し、コードの再利用性と可読性を向上させる方針を採用
- match_phonemes.py のアライメントロジック改善時に、検証部分を単一責任の原則に基づいて関数化し、コードの品質を向上
